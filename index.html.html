<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Defender - Valley of Hallucinations</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Arial', sans-serif; overflow: hidden; background: linear-gradient(135deg, #ff9a76 0%, #fad0c4 50%, #ffd1ff 100%); }
        #gameCanvas { display: block; width: 100%; height: 100vh; }
        #titleScreen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, rgba(26, 26, 46, 0.95) 0%, rgba(22, 33, 62, 0.95) 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; }
        #gameTitle { font-size: 72px; font-weight: bold; color: #00d9ff; text-shadow: 0 0 30px rgba(0, 217, 255, 0.8), 0 0 60px rgba(0, 217, 255, 0.4); letter-spacing: 4px; margin-bottom: 20px; animation: titleGlow 2s ease-in-out infinite; text-align: center; }
        #gameSubtitle { font-size: 32px; color: #ff6b9d; text-shadow: 0 0 20px rgba(255, 107, 157, 0.6); margin-bottom: 50px; }
        @keyframes titleGlow { 0%, 100% { text-shadow: 0 0 30px rgba(0, 217, 255, 0.8), 0 0 60px rgba(0, 217, 255, 0.4); } 50% { text-shadow: 0 0 40px rgba(0, 217, 255, 1), 0 0 80px rgba(0, 217, 255, 0.6); } }
        #howToPlay { background: rgba(255, 255, 255, 0.1); padding: 30px 50px; border-radius: 15px; border: 2px solid rgba(0, 217, 255, 0.5); margin-bottom: 40px; }
        #howToPlay h2 { color: #ffd700; font-size: 28px; margin-bottom: 20px; text-align: center; }
        .control-item { color: #ffffff; font-size: 20px; margin: 15px 0; display: flex; align-items: center; }
        .control-key { background: linear-gradient(135deg, #00d9ff, #0080ff); padding: 8px 16px; border-radius: 8px; font-weight: bold; margin-right: 15px; min-width: 120px; text-align: center; }
        #startButton { background: linear-gradient(135deg, #ff6b9d, #c44569); color: white; font-size: 36px; font-weight: bold; padding: 20px 60px; border: none; border-radius: 15px; cursor: pointer; box-shadow: 0 10px 30px rgba(255, 107, 157, 0.5); animation: buttonPulse 1.5s ease-in-out infinite; transition: transform 0.2s; }
        #startButton:hover { transform: scale(1.1); }
        @keyframes buttonPulse { 0%, 100% { box-shadow: 0 10px 30px rgba(255, 107, 157, 0.5); } 50% { box-shadow: 0 10px 40px rgba(255, 107, 157, 0.8); } }
        .game-ui { position: absolute; font-weight: bold; pointer-events: none; z-index: 10; background: rgba(255, 255, 255, 0.8); padding: 15px 25px; border-radius: 10px; display: none; }
        #titleOverlay { position: absolute; top: 40px; left: 50%; transform: translateX(-50%); font-size: 48px; font-weight: bold; color: #ff6b9d; text-shadow: 0 0 20px rgba(255, 107, 157, 0.8); pointer-events: none; z-index: 10; letter-spacing: 3px; display: none; }
        #scoreDisplay { top: 40px; right: 40px; color: #4a90e2; font-size: 32px; text-shadow: 0 0 15px rgba(74, 144, 226, 0.8); border: 2px solid #4a90e2; }
        #healthDisplay { top: 110px; right: 40px; color: #ff3333; font-size: 28px; text-shadow: 0 0 15px rgba(255, 51, 51, 0.8); border: 2px solid #ff3333; }
        #bossHealthDisplay { top: 200px; left: 50%; transform: translateX(-50%); color: #9d6bff; font-size: 32px; text-shadow: 0 0 20px rgba(157, 107, 255, 0.8); background: rgba(255, 255, 255, 0.9); padding: 20px 40px; border-radius: 15px; border: 3px solid #9d6bff; }
        #batteryDisplay { top: 40px; left: 40px; color: #ffd700; font-size: 24px; text-shadow: 0 0 15px rgba(255, 215, 0, 0.8); border: 2px solid #ffd700; }
        #shieldDisplay { top: 180px; right: 40px; color: #00d9ff; font-size: 24px; text-shadow: 0 0 15px rgba(0, 217, 255, 0.8); border: 2px solid #00d9ff; }
        .progress-bar { width: 200px; height: 20px; background: rgba(0, 0, 0, 0.2); border-radius: 10px; margin-top: 10px; overflow: hidden; border: 2px solid; }
        #shieldBar { border-color: #00d9ff; }
        #batteryBar { border-color: #ffd700; }
        .bar-fill { height: 100%; width: 100%; transition: width 0.1s linear; }
        #shieldBarFill { background: linear-gradient(90deg, #00d9ff, #0080ff); box-shadow: 0 0 10px rgba(0, 217, 255, 0.8); }
        #batteryBarFill { background: linear-gradient(90deg, #ffd700, #ffaa00); box-shadow: 0 0 10px rgba(255, 215, 0, 0.8); }
        #instructions { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); color: #333; font-size: 16px; text-align: center; background: rgba(255, 255, 255, 0.9); padding: 15px 30px; border-radius: 10px; border: 2px solid #ff6b9d; pointer-events: none; z-index: 10; line-height: 1.6; display: none; }
        .overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-weight: bold; pointer-events: none; z-index: 15; text-align: center; background: rgba(255, 255, 255, 0.95); padding: 30px 50px; border-radius: 15px; display: none; max-width: 80%; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3); }
        #educationalTip { font-size: 28px; color: #4a90e2; text-shadow: 0 0 10px rgba(74, 144, 226, 0.5); border: 3px solid #4a90e2; }
        #hallucinationWarning { font-size: 32px; color: #ff3333; text-shadow: 0 0 15px rgba(255, 51, 51, 0.8); border: 3px solid #ff3333; }
        #victoryOverlay { font-size: 64px; color: #00ff88; text-shadow: 0 0 30px rgba(0, 255, 136, 0.9); z-index: 20; letter-spacing: 5px; animation: pulse 1.5s ease-in-out infinite; background: none; border: none; }
        #certificateOverlay { z-index: 25; background: linear-gradient(135deg, #ffffff 0%, #f0f0f0 100%); padding: 50px; border: 5px solid #ffd700; max-width: 700px; }
        #certificateTitle { font-size: 48px; color: #4a90e2; margin-bottom: 20px; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); }
        #certificateText { font-size: 24px; color: #333; margin-bottom: 30px; line-height: 1.6; }
        #certificateStars { font-size: 60px; margin: 20px 0; }
        #certificateScore { font-size: 28px; color: #ff6b9d; margin-top: 20px; }
        #gameOverOverlay { font-size: 64px; color: #ff3333; text-shadow: 0 0 30px rgba(255, 51, 51, 0.9); z-index: 20; letter-spacing: 5px; animation: glitch 0.3s ease-in-out infinite; background: none; border: none; }
        @keyframes pulse { 0%, 100% { transform: translate(-50%, -50%) scale(1); } 50% { transform: translate(-50%, -50%) scale(1.1); } }
        @keyframes glitch { 0% { transform: translate(-50%, -50%) skew(0deg); } 25% { transform: translate(-48%, -50%) skew(-2deg); } 50% { transform: translate(-52%, -50%) skew(2deg); } 75% { transform: translate(-50%, -48%) skew(-1deg); } 100% { transform: translate(-50%, -50%) skew(0deg); } }
        .subtext { font-size: 24px; margin-top: 20px; color: #ffffff; text-shadow: 0 0 10px rgba(255, 255, 255, 0.5); }
        .confetti { position: absolute; width: 10px; height: 10px; pointer-events: none; z-index: 30; }
    </style>
</head>
<body>
    <div id="titleScreen">
        <div id="gameTitle">DATA DEFENDER</div>
        <div id="gameSubtitle">The Valley of Hallucinations</div>
        <div id="howToPlay">
            <h2>üéÆ HOW TO PLAY</h2>
            <div class="control-item"><span class="control-key">ARROW KEYS</span><span>Move your robot</span></div>
            <div class="control-item"><span class="control-key">SPACEBAR</span><span>Jump over obstacles</span></div>
            <div class="control-item"><span class="control-key">SHIFT</span><span>Truth Lens (verify AI content)</span></div>
        </div>
        <button id="startButton">START GAME</button>
    </div>
    <div id="titleOverlay">VALLEY OF HALLUCINATIONS</div>
    <div id="scoreDisplay" class="game-ui">FACTS: <span id="scoreValue">0</span> / 5</div>
    <div id="healthDisplay" class="game-ui">‚ù§Ô∏è HEALTH: <span id="healthValue">3</span></div>
    <div id="bossHealthDisplay" class="game-ui">üé≠ ECHO CHAMBER: <span id="bossHealthValue">3</span> HP</div>
    <div id="batteryDisplay" class="game-ui">üîç TRUTH LENS<div id="batteryBar" class="progress-bar"><div id="batteryBarFill" class="bar-fill"></div></div></div>
    <div id="shieldDisplay" class="game-ui">üõ°Ô∏è FIREWALL ACTIVE<div id="shieldBar" class="progress-bar"><div id="shieldBarFill" class="bar-fill"></div></div></div>
    <div id="instructions"><b>Arrow Keys:</b> Move ‚Ä¢ <b>SPACE:</b> Jump ‚Ä¢ <b>SHIFT:</b> Truth Lens<br>Use the Lens to reveal hidden platforms and verify facts!</div>
    <div id="educationalTip" class="overlay"></div>
    <div id="hallucinationWarning" class="overlay"></div>
    <div id="victoryOverlay" class="overlay">BOSS DEFEATED!<div class="subtext">Preparing your certificate...</div></div>
    <div id="certificateOverlay" class="overlay">
        <div id="certificateTitle">üèÜ CERTIFICATE OF DIGITAL LITERACY üèÜ</div>
        <div id="certificateText">This certifies that you have successfully navigated<br>the Valley of Hallucinations and demonstrated<br><b>Critical Thinking</b> and <b>AI Literacy Skills</b></div>
        <div id="certificateStars"></div>
        <div id="certificateScore"></div>
        <div style="margin-top: 30px; font-size: 18px; color: #666;">You've learned to verify AI content before trusting it!</div>
    </div>
    <div id="gameOverOverlay" class="overlay">CONNECTION LOST<div class="subtext">Restarting in <span id="countdownValue">3</span>...</div></div>
    <canvas id="gameCanvas"></canvas>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        class SynthAudio{constructor(){this.ctx=new(window.AudioContext||window.webkitAudioContext)();this.bgmOsc=null;this.bgmGain=null}startBGM(){if(this.bgmOsc)return;this.bgmOsc=this.ctx.createOscillator();const lfo=this.ctx.createOscillator();this.bgmGain=this.ctx.createGain();const lfoG=this.ctx.createGain();this.bgmOsc.type='sine';this.bgmOsc.frequency.setValueAtTime(110,this.ctx.currentTime);lfo.type='sine';lfo.frequency.setValueAtTime(0.2,this.ctx.currentTime);lfoG.gain.setValueAtTime(0.02,this.ctx.currentTime);lfo.connect(lfoG);lfoG.connect(this.bgmGain.gain);this.bgmGain.gain.setValueAtTime(0.08,this.ctx.currentTime);this.bgmOsc.connect(this.bgmGain);this.bgmGain.connect(this.ctx.destination);this.bgmOsc.start();lfo.start()}stopBGM(){if(this.bgmOsc){this.bgmOsc.stop();this.bgmOsc=null}}play(type){const t=this.ctx.currentTime;const o=this.ctx.createOscillator();const g=this.ctx.createGain();o.connect(g);g.connect(this.ctx.destination);const configs={jump:[300,500,0.2,0.01,0.2,'sine'],lensOn:[800,1200,0.15,0.01,0.2,'sine'],lensOff:[1200,600,0.12,0.01,0.2,'sine'],collect:[523.25,1046.5,0.3,0.01,0.3,'sine'],error:[200,100,0.4,0.01,0.3,'sawtooth'],bossHit:[100,50,0.6,0.01,0.5,'sawtooth'],shield:[800,400,0.3,0.01,0.5,'square']};if(configs[type]){const[f1,f2,g1,g2,dur,wv]=configs[type];o.type=wv;o.frequency.setValueAtTime(f1,t);o.frequency.exponentialRampToValueAtTime(f2,t+0.1);g.gain.setValueAtTime(g1,t);g.gain.exponentialRampToValueAtTime(g2,t+dur);o.start(t);o.stop(t+dur)}else if(type==='explosion'){const f=this.ctx.createBiquadFilter();o.connect(f);f.connect(g);o.type='sawtooth';o.frequency.setValueAtTime(100,t);o.frequency.exponentialRampToValueAtTime(20,t+0.4);f.type='lowpass';f.frequency.setValueAtTime(2000,t);f.frequency.exponentialRampToValueAtTime(100,t+0.4);g.gain.setValueAtTime(0.5,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.4);o.start(t);o.stop(t+0.4)}else if(type==='victory'){[523.25,587.33,659.25,783.99,1046.5].forEach((f,i)=>{setTimeout(()=>{const o2=this.ctx.createOscillator();const g2=this.ctx.createGain();o2.connect(g2);g2.connect(this.ctx.destination);o2.type='triangle';o2.frequency.setValueAtTime(f,this.ctx.currentTime);g2.gain.setValueAtTime(0.2,this.ctx.currentTime);g2.gain.exponentialRampToValueAtTime(0.01,this.ctx.currentTime+0.5);o2.start();o2.stop(this.ctx.currentTime+0.5)},i*120)})}else if(type==='death'){const o2=this.ctx.createOscillator();o.connect(g);o2.connect(g);g.connect(this.ctx.destination);o.type='sawtooth';o2.type='square';o.frequency.setValueAtTime(200,t);o.frequency.exponentialRampToValueAtTime(50,t+0.5);o2.frequency.setValueAtTime(150,t);o2.frequency.exponentialRampToValueAtTime(30,t+0.5);g.gain.setValueAtTime(0.4,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.5);o.start(t);o2.start(t);o.stop(t+0.5);o2.stop(t+0.5)}}}
        const audio=new SynthAudio();
        let shake={i:0,d:0};
        function triggerShake(i=0.5,d=300){shake.i=i;shake.d=d}
        function updateShake(dt){if(shake.d>0){shake.d-=dt*1000;const a=shake.i*(shake.d/300);camera.position.x+=(Math.random()-0.5)*a;camera.position.y+=(Math.random()-0.5)*a}}
        function createConfetti(){const colors=['#ff6b9d','#00d9ff','#ffd700','#9d6bff','#00ff88'];for(let i=0;i<100;i++){setTimeout(()=>{const c=document.createElement('div');c.className='confetti';c.style.left=Math.random()*window.innerWidth+'px';c.style.top='-10px';c.style.background=colors[Math.floor(Math.random()*colors.length)];c.style.transform=`rotate(${Math.random()*360}deg)`;document.body.appendChild(c);const dur=2000+Math.random()*2000;const endY=window.innerHeight+20;const start=Date.now();const anim=()=>{const prog=(Date.now()-start)/dur;if(prog<1){c.style.top=(prog*endY)+'px';c.style.opacity=1-prog;requestAnimationFrame(anim)}else{document.body.removeChild(c)}};anim()},i*30)}}
        const tips=["AI models predict words based on patterns, not truth!","Always verify AI-generated information with trusted sources.","Large Language Models can 'hallucinate' false information.","Critical thinking is your best defense against misinformation.","AI doesn't understand context like humans do."];
        let tipIdx=0;
        function showTip(t){const el=document.getElementById('educationalTip');el.textContent=t;el.style.display='block';setTimeout(()=>el.style.display='none',2000)}
        function showWarning(){const el=document.getElementById('hallucinationWarning');el.innerHTML='‚ö†Ô∏è AI HALLUCINATION DETECTED!<br><div style="font-size: 20px; margin-top: 15px;">Always check your sources!</div>';el.style.display='block';setTimeout(()=>el.style.display='none',2000)}
        let started=false,score=0,health=3,won=false,lost=false,resetting=false,shield=false,shieldTime=0,paused=false,bossOn=false,bossHP=3,bossDone=false,lens=false,battery=100,lensWas=false;
        const totalFacts=5,shieldDur=10,maxBat=100,batDrain=15,batCharge=5;
        let vy=0;const grav=-0.025,jump=0.4,gndLvl=0.4;let grnd=true;
        const scene=new THREE.Scene();scene.background=new THREE.Color(0xffd1ff);scene.fog=new THREE.Fog(0xffc4d6,15,40);
        const origBg=new THREE.Color(0xffd1ff),origFog=new THREE.Color(0xffc4d6),lensBg=new THREE.Color(0x1a3a52),lensFog=new THREE.Color(0x0d1f2d);
        const camera=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,0.1,1000);
        camera.position.set(0,8,12);
        const camTgt=new THREE.Vector3(0,0,0),camOff=new THREE.Vector3(0,8,12);
        let cinAngle=0;
        const renderer=new THREE.WebGLRenderer({canvas:document.getElementById('gameCanvas'),antialias:true});
        renderer.setSize(window.innerWidth,window.innerHeight);renderer.shadowMap.enabled=true;
        scene.add(new THREE.AmbientLight(0xffffff,1.2));
        const dirLight=new THREE.DirectionalLight(0xffe4e1,0.8);dirLight.position.set(5,10,5);dirLight.castShadow=true;dirLight.shadow.camera.left=-30;dirLight.shadow.camera.right=30;dirLight.shadow.camera.top=30;dirLight.shadow.camera.bottom=-30;scene.add(dirLight);
        const accent=new THREE.PointLight(0xffb3d9,1.5,20);accent.position.set(0,5,0);scene.add(accent);
        const gndGeo=new THREE.PlaneGeometry(80,80,40,40),gndMat=new THREE.MeshStandardMaterial({color:0xe8d5ff,roughness:0.9,metalness:0.1,flatShading:true});
        const gnd=new THREE.Mesh(gndGeo,gndMat);gnd.rotation.x=-Math.PI/2;gnd.receiveShadow=true;
        const verts=gnd.geometry.attributes.position.array;
        for(let i=0;i<verts.length;i+=3){const x=verts[i],z=verts[i+1];verts[i+2]=Math.sin(x*0.1)*Math.cos(z*0.1)*2+Math.sin(x*0.05)*1.5+Math.cos(z*0.08)*1.2}
        gnd.geometry.attributes.position.needsUpdate=true;gnd.geometry.computeVertexNormals();
        scene.add(new THREE.GridHelper(80,40,0xd8b5ff,0xe8d5ff));scene.add(gnd);
        const shad=new THREE.Mesh(new THREE.CircleGeometry(0.6,16),new THREE.MeshBasicMaterial({color:0x000000,transparent:true,opacity:0.3}));
        shad.rotation.x=-Math.PI/2;shad.position.y=0.02;scene.add(shad);
        const robot=new THREE.Group();
        const bMat=new THREE.MeshStandardMaterial({color:0x6b9bd1,roughness:0.3,metalness:0.7,flatShading:true,emissive:0x4a7ba7,emissiveIntensity:0.3});
        const jMat=new THREE.MeshStandardMaterial({color:0x87ceeb,roughness:0.2,metalness:0.8,flatShading:true,emissive:0x87ceeb,emissiveIntensity:0.5});
        const head=new THREE.Mesh(new THREE.SphereGeometry(0.3,8,6),bMat);head.position.y=1.2;head.castShadow=true;robot.add(head);
        const eMat=new THREE.MeshStandardMaterial({color:0xffffff,emissive:0x87ceeb,emissiveIntensity:1});
        const lEye=new THREE.Mesh(new THREE.SphereGeometry(0.08,6,4),eMat);lEye.position.set(-0.12,1.25,0.25);robot.add(lEye);
        const rEye=new THREE.Mesh(new THREE.SphereGeometry(0.08,6,4),eMat);rEye.position.set(0.12,1.25,0.25);robot.add(rEye);
        const body=new THREE.Mesh(new THREE.CylinderGeometry(0.35,0.4,0.8,8),bMat);body.position.y=0.5;body.castShadow=true;robot.add(body);
        const lArm=new THREE.Mesh(new THREE.CylinderGeometry(0.08,0.08,0.6,6),bMat);lArm.position.set(-0.5,0.5,0);lArm.castShadow=true;robot.add(lArm);
        const rArm=new THREE.Mesh(new THREE.CylinderGeometry(0.08,0.08,0.6,6),bMat);rArm.position.set(0.5,0.5,0);rArm.castShadow=true;robot.add(rArm);
        const lSh=new THREE.Mesh(new THREE.SphereGeometry(0.12,6,4),jMat);lSh.position.set(-0.5,0.8,0);robot.add(lSh);
        const rSh=new THREE.Mesh(new THREE.SphereGeometry(0.12,6,4),jMat);rSh.position.set(0.5,0.8,0);robot.add(rSh);
        const lLeg=new THREE.Mesh(new THREE.CylinderGeometry(0.1,0.1,0.5,6),bMat);lLeg.position.set(-0.15,-0.15,0);lLeg.castShadow=true;robot.add(lLeg);
        const rLeg=new THREE.Mesh(new THREE.CylinderGeometry(0.1,0.1,0.5,6),bMat);rLeg.position.set(0.15,-0.15,0);rLeg.castShadow=true;robot.add(rLeg);
        const lHip=new THREE.Mesh(new THREE.SphereGeometry(0.12,6,4),jMat);lHip.position.set(-0.15,0.1,0);robot.add(lHip);
        const rHip=new THREE.Mesh(new THREE.SphereGeometry(0.12,6,4),jMat);rHip.position.set(0.15,0.1,0);robot.add(rHip);
        robot.position.set(-18,gndLvl,0);scene.add(robot);
        const shieldMesh=new THREE.Mesh(new THREE.SphereGeometry(1.5,16,12),new THREE.MeshBasicMaterial({color:0x87ceeb,transparent:true,opacity:0.3,side:THREE.DoubleSide}));
        shieldMesh.visible=false;robot.add(shieldMesh);
        const plats=[];
        function makePlat(x,y,z,w,d){const g=new THREE.Group();const sm=new THREE.Mesh(new THREE.BoxGeometry(w,0.5,d),new THREE.MeshStandardMaterial({color:0x87ceeb,transparent:true,opacity:0,roughness:0.5,metalness:0.5}));sm.position.set(x,y,z);sm.castShadow=true;sm.receiveShadow=true;const wm=new THREE.Mesh(new THREE.BoxGeometry(w,0.5,d),new THREE.MeshBasicMaterial({color:0x00ffff,wireframe:true,transparent:true,opacity:0}));wm.position.set(x,y,z);g.add(sm);g.add(wm);g.userData={solid:sm,wire:wm};scene.add(g);plats.push(g)}
        makePlat(-15,1,0,3,3);makePlat(-12,1.5,3,3,3);makePlat(-9,2,0,3,3);makePlat(-6,1.5,-3,3,3);makePlat(-3,1,0,3,3);
        let boss=null,crates=[];
        function makeBoss(){boss=new THREE.Group();const hMat=new THREE.MeshStandardMaterial({color:0x9d6bff,emissive:0x651fff,emissiveIntensity:0.5,roughness:0.4,metalness:0.8,flatShading:true});const bHead=new THREE.Mesh(new THREE.IcosahedronGeometry(3,0),hMat);bHead.castShadow=true;boss.add(bHead);for(let i=0;i<8;i++){const f=new THREE.Mesh(new THREE.TetrahedronGeometry(0.5,0),hMat);const a=(i/8)*Math.PI*2;f.position.set(Math.cos(a)*5,Math.sin(a)*2,Math.sin(a)*5);f.userData={angle:a,speed:0.02};boss.add(f)}boss.add(new THREE.PointLight(0x9d6bff,3,15));boss.position.set(20,8,0);boss.userData.y=8;scene.add(boss)}
        function spawnCrates(){crates.forEach(c=>scene.remove(c));crates=[];const keyIdx=Math.floor(Math.random()*3);[{x:15,z:-3},{x:15,z:0},{x:15,z:3}].forEach((p,i)=>{const g=new THREE.Group();const c=new THREE.Mesh(new THREE.BoxGeometry(1.2,1.2,1.2),new THREE.MeshStandardMaterial({color:0xffd700,emissive:0xffaa00,emissiveIntensity:0.4,roughness:0.4,metalness:0.8,flatShading:true}));c.castShadow=true;g.add(c);const w=new THREE.Mesh(new THREE.BoxGeometry(1.3,1.3,1.3),new THREE.MeshBasicMaterial({color:i===keyIdx?0x00ff00:0xff0000,wireframe:true,transparent:true,opacity:0}));g.add(w);g.position.set(p.x,2,p.z);g.userData={isKey:i===keyIdx,coll:false,wire:w,crate:c,rot:0.02};scene.add(g);crates.push(g)})}
        makeBoss();
        let fw=null;
        function spawnFW(){if(fw)scene.remove(fw);fw=new THREE.Group();const m=new THREE.Mesh(new THREE.IcosahedronGeometry(0.5,0),new THREE.MeshStandardMaterial({color:0x87ceeb,emissive:0x87ceeb,emissiveIntensity:0.9,roughness:0.2,metalness:0.8,flatShading:true,transparent:true,opacity:0.9}));m.castShadow=true;fw.add(m);fw.add(new THREE.PointLight(0x87ceeb,2,6));fw.position.set(5,2.5,-8);fw.userData={coll:false,y:2.5};scene.add(fw)}
        spawnFW();
        const dfs=[];
        function makeDF(sx,sz,ex,ez){const d=new THREE.Group();const m1=new THREE.MeshStandardMaterial({color:0xff6b9d,emissive:0xff1744,emissiveIntensity:0.7,roughness:0.4,metalness:0.8,flatShading:true});const m2=new THREE.MeshStandardMaterial({color:0x9d6bff,emissive:0x651fff,emissiveIntensity:0.7,roughness:0.4,metalness:0.8,flatShading:true});const core=new THREE.Mesh(new THREE.OctahedronGeometry(0.5,0),m1);core.castShadow=true;d.add(core);[[0.5,0,0],[-0.5,0,0],[0,0.5,0],[0,-0.5,0],[0,0,0.5],[0,0,-0.5]].forEach(p=>{const s=new THREE.Mesh(new THREE.ConeGeometry(0.15,0.6,4),m1);s.position.set(p[0],p[1],p[2]);s.lookAt(p[0]*2,p[1]*2,p[2]*2);s.castShadow=true;d.add(s)});d.add(new THREE.PointLight(0xff1744,1.5,4));d.userData={sx,sz,ex,ez,prog:0,spd:0.01+Math.random()*0.005,dir:1,dest:false,m1,m2,flick:0};d.position.set(sx,1,sz);scene.add(d);dfs.push(d)}
        makeDF(8,-10,16,-10);makeDF(-8,10,8,10);
        const exps=[];
        function makeExp(x,y,z,col){for(let i=0;i<20;i++){const p=new THREE.Mesh(new THREE.SphereGeometry(0.1,4,4),new THREE.MeshBasicMaterial({color:col||(Math.random()>0.5?0xff6b9d:0x9d6bff),transparent:true,opacity:1}));p.position.set(x,y,z);p.userData={vel:new THREE.Vector3((Math.random()-0.5)*0.3,Math.random()*0.2,(Math.random()-0.5)*0.3),life:1};scene.add(p);exps.push(p)}}
        const facts=[],fakes=[];
        function validPos(x,z,ps){const d=Math.sqrt((x+18)*(x+18)+z*z);if(d<5)return false;for(let p of ps){const d2=Math.sqrt((x-p.x)**2+(z-p.z)**2);if(d2<3)return false}return true}
        function spawnFacts(){const ps=[],mims=[1,3];for(let i=0;i<totalFacts;i++){let x,z,ok=false,tries=0;while(!ok&&tries<50){x=(Math.random()-0.3)*40-5;z=(Math.random()-0.5)*30;ok=validPos(x,z,ps);tries++}const g=new THREE.Group(),isMim=mims.includes(i);const fMat=new THREE.MeshStandardMaterial({color:0x4a90e2,emissive:0x2196f3,emissiveIntensity:0.6,roughness:0.3,metalness:0.7,flatShading:true});const mMat=new THREE.MeshStandardMaterial({color:0xff3333,emissive:0xff1744,emissiveIntensity:0.7,roughness:0.3,metalness:0.7,flatShading:true});const f=new THREE.Mesh(new THREE.BoxGeometry(0.6,0.6,0.6),fMat);f.castShadow=true;g.add(f);g.add(new THREE.PointLight(0x4a90e2,1.2,5));const b=new THREE.Mesh(new THREE.CylinderGeometry(0.15,0.15,15,8),new THREE.MeshBasicMaterial({color:0x4a90e2,transparent:true,opacity:0.3,side:THREE.DoubleSide}));b.position.y=7.5;g.add(b);g.position.set(x,1.5,z);g.userData={coll:false,y:1.5,off:Math.random()*Math.PI*2,mim:isMim,nMat:fMat,mMat:mMat,mesh:f};scene.add(g);facts.push(g);ps.push({x,z})}for(let i=0;i<2;i++){let x,z,ok=false,tries=0;while(!ok&&tries<50){x=(Math.random()-0.3)*40-5;z=(Math.random()-0.5)*30;ok=validPos(x,z,ps);tries++}const g=new THREE.Group();const f=new THREE.Mesh(new THREE.SphereGeometry(0.5,10,8),new THREE.MeshStandardMaterial({color:0xff3333,emissive:0xff1744,emissiveIntensity:0.7,roughness:0.3,metalness:0.7,flatShading:true}));f.castShadow=true;g.add(f);g.add(new THREE.PointLight(0xff3333,1.2,5));const b=new THREE.Mesh(new THREE.CylinderGeometry(0.15,0.15,15,8),new THREE.MeshBasicMaterial({color:0xff3333,transparent:true,opacity:0.3,side:THREE.DoubleSide}));b.position.y=7.5;g.add(b);g.position.set(x,1.5,z);g.userData={coll:false,y:1.5,off:Math.random()*Math.PI*2};scene.add(g);fakes.push(g);ps.push({x,z})}}
        spawnFacts();
        const trail=[];
        function makeTrail(x,y,z){const p=new THREE.Mesh(new THREE.SphereGeometry(0.15,6,4),new THREE.MeshBasicMaterial({color:0xb19cd9,transparent:true,opacity:0.6}));p.position.set(x,y,z);p.userData.life=1;scene.add(p);trail.push(p);if(trail.length>30){const old=trail.shift();scene.remove(old)}}
        const mv={f:false,b:false,l:false,r:false};
        let pv={x:0,z:0},tTim=0,aSwing=0,lSwing=0;
        document.addEventListener('keydown',e=>{if(won||lost||paused)return;switch(e.key){case 'ArrowUp':mv.f=true;break;case 'ArrowDown':mv.b=true;break;case 'ArrowLeft':mv.l=true;break;case 'ArrowRight':mv.r=true;break;case ' ':if(grnd){vy=jump;grnd=false;audio.play('jump')}e.preventDefault();break;case 'Shift':if(battery>0&&!lens){lens=true;if(!lensWas)audio.play('lensOn');lensWas=true}break}});
        document.addEventListener('keyup',e=>{switch(e.key){case 'ArrowUp':mv.f=false;break;case 'ArrowDown':mv.b=false;break;case 'ArrowLeft':mv.l=false;break;case 'ArrowRight':mv.r=false;break;case 'Shift':lens=false;if(lensWas)audio.play('lensOff');lensWas=false;break}});
        function updPlr(){if(won||lost||paused)return;pv.x=0;pv.z=0;if(mv.f)pv.z-=0.15;if(mv.b)pv.z+=0.15;if(mv.l)pv.x-=0.15;if(mv.r)pv.x+=0.15;robot.position.x+=pv.x;robot.position.z+=pv.z;robot.position.x=Math.max(-35,Math.min(35,robot.position.x));robot.position.z=Math.max(-35,Math.min(35,robot.position.z));vy+=grav;robot.position.y+=vy;let onP=false;plats.forEach(p=>{const pm=p.userData.solid.position,ps=new THREE.Vector3();new THREE.Box3().setFromObject(p.userData.solid).getSize(ps);if(Math.abs(robot.position.x-pm.x)<ps.x/2&&Math.abs(robot.position.z-pm.z)<ps.z/2&&robot.position.y<=pm.y+ps.y/2+0.5&&robot.position.y>=pm.y-ps.y/2){onP=true;if(vy<0){robot.position.y=pm.y+ps.y/2+gndLvl;vy=0;grnd=true}}});if(!onP&&robot.position.y<=gndLvl){robot.position.y=gndLvl;vy=0;grnd=true}shad.position.x=robot.position.x;shad.position.z=robot.position.z;const hAG=robot.position.y-gndLvl;shad.scale.set(0.6+hAG*0.3,0.6+hAG*0.3,1);shad.material.opacity=Math.max(0.1,0.3-hAG*0.1);if(pv.x!==0||pv.z!==0){robot.rotation.y=Math.atan2(pv.x,pv.z);if(grnd){aSwing+=0.15;lSwing+=0.15;lArm.rotation.x=Math.sin(aSwing)*0.4;rArm.rotation.x=-Math.sin(aSwing)*0.4;lLeg.rotation.x=Math.sin(lSwing)*0.3;rLeg.rotation.x=-Math.sin(lSwing)*0.3}else{lArm.rotation.x=-0.5;rArm.rotation.x=-0.5;lLeg.rotation.x=0.3;rLeg.rotation.x=0.3}tTim++;if(tTim%3===0)makeTrail(robot.position.x,robot.position.y+0.5,robot.position.z)}else{lArm.rotation.x*=0.9;rArm.rotation.x*=0.9;lLeg.rotation.x*=0.9;rLeg.rotation.x*=0.9}}
        function updCam(){if(started){const tPos=new THREE.Vector3(robot.position.x+camOff.x,robot.position.y+camOff.y,robot.position.z+camOff.z);camera.position.lerp(tPos,0.05);camTgt.lerp(robot.position,0.1);camera.lookAt(camTgt)}else{cinAngle+=0.001;camera.position.x=Math.cos(cinAngle)*15;camera.position.z=Math.sin(cinAngle)*15;camera.position.y=10;camera.lookAt(0,0,0)}}
        function updShield(dt){if(shield){shieldTime-=dt;const pct=(shieldTime/shieldDur)*100;document.getElementById('shieldBarFill').style.width=pct+'%';const sc=1+Math.sin(Date.now()*0.01)*0.05;shieldMesh.scale.set(sc,sc,sc);shieldMesh.material.opacity=0.2+(shieldTime/shieldDur)*0.2;if(shieldTime<=0){shield=false;shieldMesh.visible=false;document.getElementById('shieldDisplay').style.display='none'}}}
        function updLens(dt){if(lens){battery=Math.max(0,battery-batDrain*dt);if(battery<=0){lens=false;battery=0}scene.background.lerp(lensBg,0.1);scene.fog.color.lerp(lensFog,0.1);plats.forEach(p=>{p.userData.wire.material.opacity=Math.min(1,p.userData.wire.material.opacity+0.1);p.userData.solid.material.opacity=Math.min(0.5,p.userData.solid.material.opacity+0.05)});facts.forEach(f=>{if(f.userData.mim&&!f.userData.coll){f.userData.mesh.material=f.userData.mMat;if(f.children.length>2)f.children[2].material.color.set(0xff3333)}});crates.forEach(c=>{if(!c.userData.coll)c.userData.wire.material.opacity=Math.min(0.8,c.userData.wire.material.opacity+0.1)})}else{battery=Math.min(maxBat,battery+batCharge*dt);scene.background.lerp(origBg,0.1);scene.fog.color.lerp(origFog,0.1);plats.forEach(p=>{p.userData.wire.material.opacity=Math.max(0,p.userData.wire.material.opacity-0.1);p.userData.solid.material.opacity=Math.max(0,p.userData.solid.material.opacity-0.05)});facts.forEach(f=>{if(f.userData.mim&&!f.userData.coll){f.userData.mesh.material=f.userData.nMat;if(f.children.length>2)f.children[2].material.color.set(0x4a90e2)}});crates.forEach(c=>{if(!c.userData.coll)c.userData.wire.material.opacity=Math.max(0,c.userData.wire.material.opacity-0.1)})}document.getElementById('batteryBarFill').style.width=(battery/maxBat)*100+'%'}
        function updBoss(){if(!boss)return;boss.position.y=boss.userData.y+Math.sin(Date.now()*0.002)*0.5;boss.children[0].rotation.y+=0.01;boss.children[0].rotation.x=Math.sin(Date.now()*0.003)*0.2;for(let i=1;i<boss.children.length-1;i++){const f=boss.children[i];if(f.userData.angle!==undefined){f.userData.angle+=f.userData.speed;f.position.x=Math.cos(f.userData.angle)*5;f.position.y=Math.sin(f.userData.angle)*2;f.position.z=Math.sin(f.userData.angle)*5;f.rotation.x+=0.05;f.rotation.y+=0.03}}if(!bossOn&&robot.position.x>5){bossOn=true;document.getElementById('bossHealthDisplay').style.display='block';document.getElementById('bossHealthValue').textContent=bossHP;spawnCrates()}}
        function updCrates(){crates.forEach(c=>{if(!c.userData.coll){c.userData.crate.rotation.y+=c.userData.rot;c.userData.crate.rotation.x+=c.userData.rot*0.5}})}
        function updDFs(){dfs.forEach(d=>{if(d.userData.dest)return;const dt=d.userData;dt.flick++;if(dt.flick%20===0){const m=((dt.flick/20)%2===0)?dt.m1:dt.m2;d.children.forEach(c=>{if(c.isMesh)c.material=m})}dt.prog+=dt.spd*dt.dir;if(dt.prog>=1){dt.prog=1;dt.dir=-1}else if(dt.prog<=0){dt.prog=0;dt.dir=1}d.position.x=dt.sx+(dt.ex-dt.sx)*dt.prog;d.position.z=dt.sz+(dt.ez-dt.sz)*dt.prog;d.rotation.y+=0.03;d.rotation.x=Math.sin(Date.now()*0.005)*0.2;d.position.y=1+Math.sin(Date.now()*0.004)*0.2})}
        function updExps(){for(let i=exps.length-1;i>=0;i--){const p=exps[i];p.userData.life-=0.02;p.material.opacity=p.userData.life;p.position.add(p.userData.vel);p.userData.vel.y-=0.01;if(p.userData.life<=0){scene.remove(p);exps.splice(i,1)}}}
        function updTrail(){for(let i=trail.length-1;i>=0;i--){const p=trail[i];p.userData.life-=0.02;p.material.opacity=p.userData.life*0.6;p.scale.set(p.userData.life,p.userData.life,p.userData.life);if(p.userData.life<=0){scene.remove(p);trail.splice(i,1)}}}
        function updColls(){[...facts,...fakes].forEach(g=>{if(!g.userData.coll){g.position.y=g.userData.y+Math.sin(Date.now()*0.002+g.userData.off)*0.3;g.children[0].rotation.y+=0.02;g.children[0].rotation.x+=0.01;if(g.children.length>2)g.children[2].material.opacity=0.2+Math.sin(Date.now()*0.003)*0.1}});if(fw&&!fw.userData.coll){fw.position.y=fw.userData.y+Math.sin(Date.now()*0.003)*0.4;fw.rotation.x+=0.01;fw.rotation.y+=0.015}}
        function checkColls(){if(won||lost||paused)return;facts.forEach(f=>{if(f.userData.coll)return;if(robot.position.distanceTo(f.position)<1.5){f.userData.coll=true;if(f.userData.mim){audio.play('error');health--;document.getElementById('healthValue').textContent=health;showWarning();triggerShake();if(health<=0){lost=true;handleDeath()}}else{audio.play('collect');score++;document.getElementById('scoreValue').textContent=score;paused=true;showTip(tips[tipIdx]);tipIdx=(tipIdx+1)%tips.length;setTimeout(()=>paused=false,2000)}const si=setInterval(()=>{f.scale.multiplyScalar(0.9);if(f.scale.x<0.1){scene.remove(f);clearInterval(si)}},16)}});fakes.forEach(f=>{if(f.userData.coll)return;if(robot.position.distanceTo(f.position)<1.5){f.userData.coll=true;const si=setInterval(()=>{f.scale.multiplyScalar(0.9);if(f.scale.x<0.1){scene.remove(f);clearInterval(si)}},16);audio.play('error');health--;document.getElementById('healthValue').textContent=health;showWarning();triggerShake();if(health<=0){lost=true;handleDeath()}}});if(fw&&!fw.userData.coll&&robot.position.distanceTo(fw.position)<1.5){fw.userData.coll=true;const si=setInterval(()=>{fw.scale.multiplyScalar(0.85);if(fw.scale.x<0.1){scene.remove(fw);clearInterval(si)}},16);shield=true;shieldTime=shieldDur;shieldMesh.visible=true;document.getElementById('shieldDisplay').style.display='block';audio.play('shield')}dfs.forEach(d=>{if(d.userData.dest)return;if(robot.position.distanceTo(d.position)<1.2){if(shield){d.userData.dest=true;makeExp(d.position.x,d.position.y,d.position.z);audio.play('explosion');const si=setInterval(()=>{d.scale.multiplyScalar(0.85);if(d.scale.x<0.1){scene.remove(d);clearInterval(si)}},16)}else{health--;document.getElementById('healthValue').textContent=health;audio.play('error');triggerShake();vy=0.3;const kb=new THREE.Vector3().subVectors(robot.position,d.position).normalize().multiplyScalar(2);robot.position.add(kb);if(health<=0){lost=true;handleDeath()}}}});if(!bossOn||bossDone)return;crates.forEach(c=>{if(c.userData.coll)return;if(robot.position.distanceTo(c.position)<2){c.userData.coll=true;if(c.userData.isKey){bossHP--;document.getElementById('bossHealthValue').textContent=bossHP;audio.play('bossHit');makeExp(boss.position.x,boss.position.y,boss.position.z,0x9d6bff);boss.scale.set(0.9,0.9,0.9);setTimeout(()=>boss.scale.set(1,1,1),200);if(bossHP<=0)defeatBoss();else setTimeout(()=>spawnCrates(),1000)}else{health--;document.getElementById('healthValue').textContent=health;audio.play('error');triggerShake();vy=0.3;const kb=new THREE.Vector3().subVectors(robot.position,c.position).normalize().multiplyScalar(2);robot.position.add(kb);if(health<=0){lost=true;handleDeath()}else setTimeout(()=>spawnCrates(),1000)}scene.remove(c)}})}
        function defeatBoss(){bossDone=true;won=true;makeExp(boss.position.x,boss.position.y,boss.position.z,0x9d6bff);makeExp(boss.position.x+2,boss.position.y+1,boss.position.z+1,0xff6b9d);makeExp(boss.position.x-2,boss.position.y-1,boss.position.z-1,0x00d9ff);audio.play('victory');scene.remove(boss);document.getElementById('bossHealthDisplay').style.display='none';document.getElementById('victoryOverlay').style.display='block';document.getElementById('instructions').style.display='none';setTimeout(()=>showCert(),3000)}
        function showCert(){document.getElementById('victoryOverlay').style.display='none';const maxSc=totalFacts+3;const stars=Math.ceil((score/maxSc)*5);document.getElementById('certificateStars').textContent='‚≠ê'.repeat(Math.max(1,stars));document.getElementById('certificateScore').innerHTML=`<b>Final Score: ${score}</b><br>Rating: ${stars}/5 Stars`;document.getElementById('certificateOverlay').style.display='block';createConfetti()}
        function handleDeath(){audio.play('death');document.getElementById('gameOverOverlay').style.display='block';document.getElementById('instructions').style.display='none';shield=false;shieldMesh.visible=false;document.getElementById('shieldDisplay').style.display='none';let cd=3;const cdi=setInterval(()=>{cd--;document.getElementById('countdownValue').textContent=cd;if(cd<=0){clearInterval(cdi);resetGame()}},1000)}
        function resetGame(){resetting=true;document.getElementById('gameOverOverlay').style.display='none';document.getElementById('instructions').style.display='block';document.getElementById('bossHealthDisplay').style.display='none';document.getElementById('certificateOverlay').style.display='none';score=0;health=3;bossHP=3;bossOn=false;bossDone=false;won=false;lost=false;vy=0;grnd=true;paused=false;lens=false;battery=100;shield=false;document.getElementById('scoreValue').textContent=score;document.getElementById('healthValue').textContent=health;document.getElementById('countdownValue').textContent='3';robot.position.set(-18,gndLvl,0);robot.rotation.y=0;facts.forEach(f=>scene.remove(f));facts.length=0;fakes.forEach(f=>scene.remove(f));fakes.length=0;spawnFacts();spawnFW();dfs.forEach(d=>scene.remove(d));dfs.length=0;makeDF(8,-10,16,-10);makeDF(-8,10,8,10);crates.forEach(c=>scene.remove(c));crates.length=0;if(boss)scene.remove(boss);makeBoss();trail.forEach(p=>scene.remove(p));trail.length=0;exps.forEach(p=>scene.remove(p));exps.length=0;resetting=false}
        document.getElementById('startButton').addEventListener('click',()=>{document.getElementById('titleScreen').style.display='none';document.getElementById('titleOverlay').style.display='block';document.getElementById('scoreDisplay').style.display='block';document.getElementById('healthDisplay').style.display='block';document.getElementById('batteryDisplay').style.display='block';document.getElementById('instructions').style.display='block';started=true;audio.startBGM()});
        window.addEventListener('resize',()=>{camera.aspect=window.innerWidth/window.innerHeight;camera.updateProjectionMatrix();renderer.setSize(window.innerWidth,window.innerHeight)});
        let lastT=Date.now();
        function anim(){requestAnimationFrame(anim);const ct=Date.now();const dt=(ct-lastT)/1000;lastT=ct;if(!resetting){updPlr();updCam();updTrail();updColls();updDFs();updExps();updShield(dt);updLens(dt);updBoss();updCrates();checkColls();updateShake(dt)}accent.position.x=Math.sin(Date.now()*0.001)*5;accent.position.z=Math.cos(Date.now()*0.001)*5;renderer.render(scene,camera)}
        anim();
    </script>
</body>
</html>
